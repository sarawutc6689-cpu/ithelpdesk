<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>IT Helpdesk - เข้าสู่ระบบแอดมิน</title>
  <style>
    /* CSS Styles ของคุณ */
    .inputtext {
      width: 100%;
      vertical-align: middle;
      margin: 5px 10px 5px 0;
      padding: 10px;
      background-color: #ffffff;
      border: 2px solid #000;
      border-radius: 20px;
      box-sizing: border-box;
    }

    .button {
      width: 100%;
      vertical-align: middle;
      margin: 5px 10px 5px 0;
      padding: 10px;
      background-color: #62B1E3;
      border: 2px solid #000;
      border-radius: 20px;
      box-sizing: border-box;
      text-transform: uppercase;
      color:white;
      cursor: pointer;
    }

    div {
      font-family: arial;
      font-weight: bold;
    }

    #msg {
      color: #F70505;
    }

    body {
      overflow-y: hidden;
      overflow-x: hidden;
    }
  </style>
</head>

<body>
  <center>
    <div class="div1">
      <form name="myform" method="post">
        <input type="text" name="uname" class="inputtext" autocomplete="off" placeholder="Username" id="username_input">
        <br>
        <input type="password" name="pass" class="inputtext" autocomplete="off" placeholder="Password" id="password_input">
        <br>
        <div id="msg"></div>
        <br>
        <input type="button" class="button" name="log" id="logbutton" value="Login" onclick="myfunction()">
        <br><br>
      </form>
    </div>
  </center>

  <script type="text/javascript">
    function myfunction () {
      var user = document.getElementById("username_input").value;
      var pass = document.getElementById("password_input").value;
      var loginButton = document.getElementById("logbutton");
      var msgDiv = document.getElementById("msg");

      if (user === "" || pass === "") {
          msgDiv.innerHTML = "กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
          return;
      }
      
      // 1. ปิดปุ่มและแสดงสถานะ
      loginButton.disabled = true;
      msgDiv.innerHTML = "กำลังตรวจสอบ..."; 

      // 2. เรียก Apps Script (Server-side) เพื่อตรวจสอบ
      google.script.run
        .withSuccessHandler(handleAuthResponse) 
        .withFailureHandler(handleAuthFailure)
        .checkAdminLogin(user, pass); // ฟังก์ชันนี้อยู่ใน Code.gs
    }

    function handleAuthResponse(isSuccess) {
      var loginButton = document.getElementById("logbutton");
      var msgDiv = document.getElementById("msg");
      
      loginButton.disabled = false;

      if (isSuccess) {
        msgDiv.innerHTML = "Login สำเร็จ! กำลังนำทาง...";
        
        // 3. เมื่อ Login สำเร็จ ให้เปลี่ยนเส้นทางไปหน้า Dashboard
        // โค้ดนี้จะใช้ URL Web App หลัก แล้วต่อท้ายด้วย ?page=dashboard
        var dashboardUrl = '<?!= ScriptApp.getService().getUrl() ?>' + '?page=dashboard';
        window.top.location.href = dashboardUrl;
      } else {
        msgDiv.innerHTML = "ชื่อผู้ใช้ หรือรหัสผ่านไม่ถูกต้อง";
      }
    }
    
    function handleAuthFailure(error) {
      document.getElementById("logbutton").disabled = false;
      document.getElementById("msg").innerHTML = "❌ เกิดข้อผิดพลาดในการติดต่อระบบ: " + error.message;
      console.error(error);
    }
  </script>
</body>
</html>
